---
title: "STICr_TAL_DD"
author: "Charles Bond"
date: "10/18/2024"
output: html_document
---
# AIMS Southeastern Flow Manipulation Experiment:
## STIC data processing for decomposition assay sites
###  Summary
For the AIMS southeastern flow manipulation experiment, four transects we selected (two in the manipulated reach and two in the control reach), where each transect consisted of a pool site, a riffle site (immediately upstream of the pool), and an adjacent terrestrial/riparian site. At each site (n=12), modified HOBO loggers called *STICs* (Stream Temperature, Intermittency, and Conductivity loggers, based on Chapin et al. 2014, https://doi.org/10.1002/2013WR015158) were deployed for the duration of the experiment, taking measurements every 15 minutes. The present data processing pipeline is based on the STICr package developed by Wheeler et. al. 2023 (https://doi.org/10.31223/X5636K), and serves to provide summary visualizations of temperature, relative conductivity, and wet versus dry conditions. Additionally, we will generate average temperatures, relative conductivity, and surface water states for each decomposition assay incubation period at each STIC site. Finally, we will use temperature data to generate cumulative degree days for each incubation period so that downstream analyses can calculate temperaature normalized decay constants, a la Gessner & Peeters (https://doi.org/10.1007/978-3-030-30515-4). 

### Setup
```{r setup, include=FALSE}
options(knitr.duplicate.label = "allow")
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/chunk/Chapter_III_Decomp_assays/data_processing/STICs")
```

It loads the package before it begins or else it gets the error again
```{r, library}
library(vegan)
library(ggplot2)
library(tidyr)
library(dplyr)
library(ggfortify)
library(ggpubr)
library(stringr)
library(STICr)
```

## Loading STIC data
Each STIC was programmed to start recording after they were already deployed at their sites, but we have to manually trim records from after we pull them out of the stream, as we had to return them to University of Alabama for Delaney Peterson to deactivate and download the data (thanks Delaney!). We trim them all to 13134 records, which corresponds to just before the first STIC was removed from the stream.An important note: the STIC data is in GMT / UCT, but some field data is recorded in CST. So, we'll have to account for this when we use the data later on.

Data from each STIC must be loaded and processed individually before further analysis. 

FOR REFERENCE:
STIC names refer to their position,
"I" for impact (manipulated) reach, "C" for control reach.
"P" for pool, "R" for riffle, "T" for terrestrial.
"1" for the downstream transect of eac reach, "2" for the upstream transect of each reach. 
E.g., CT2 is the terrestrial site in the upstream transect of the control reach, while IP1 is the pool in the downstream transect of the impact reach. The TLM simply referres to Talladega (TL, the watershed) mainstem (M, the mainstem of the stream).


STICr CT2
```{r}
tidy_CT2 <- tidy_hobo_data(infile="TLM_CT2_21193659.csv", outfile = FALSE) 
head(tidy_CT2)
#trimming off ends where STICs were in transit...
tidy_CT2 <- tidy_CT2[1:13134,]

```

Below are time series plots of the uncalibrated conductivity and temperature generated by `tidy_hobo_data`

```{r }
plot(tidy_CT2$datetime, tidy_CT2$condUncal, type = "l", lty = 1, 
     xlab = "datetime", ylab = "uncalibrated conductivity")
plot(tidy_CT2$datetime, tidy_CT2$tempC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "temperature")
```

The second function is called `get_calibration` and is demonstrated below. The function intakes a STIC calibration data frame with columns `standard` and `conductivity_uncal`and outputs a fitted model object relating `spc` to the uncalibrated conductivity values measured by the STIC.

```{r example2}
# Example calibration data
head(calibration_standard_data)

lm_calibration <- get_calibration(calibration_standard_data)
# Result is a fitted model object
summary(lm_calibration)
```

The third function is called `apply_calibration` and is demonstrated below. The function intakes a tidy STIC data frame (as generated by` tidy_hobo_data`), as well as the fitted model object generated by `get_calibration`. It outputs the same STIC data frame as input, except with a new column called `spc`. This will be in the same units as the data used to develop the model calibration.

```{r }
# applying the lm_calibration object from the previous example to the tidy data frame to generate the calibrated spc column
CT2_calibrated_df <- apply_calibration(tidy_CT2, lm_calibration)
head(CT2_calibrated_df)
```

Below is a time series plot of the calibrated spc values

```{r }
plot(CT2_calibrated_df$datetime, CT2_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
```

The final function is called `classify_wetdry` and is demonstrated below. This function intakes a data frame with STIC data (such as that produced by `apply_calibration` or `tidy_hobo_data.` The user is also asked to specify a method for classification, as well as a threshold associated with that method. Currently, methods include either an absolute numerical threshold or a percentage of the highest value of the classification variable. It outputs the same STIC data frame as input, except with a new binary column called `wetdry`.

```{r }
# Creating classified data frame using "condUncal" as the classification variable, and an absolute threshold as the method for classification. The SpC threshold chosen in this case is 200. 
CT2_classified_df <- classify_wetdry(CT2_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 200)
head(CT2_classified_df)
```

Below is a time series plot of the calibrated `spc` values colored by wet versus dry periods.

```{r }
CT2_classified_df$wetdry <- as.factor(CT2_classified_df$wetdry)
plot(CT2_classified_df$datetime, CT2_classified_df$condUncal,
     col = CT2_classified_df$wetdry,
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(CT2_classified_df$datetime, CT2_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)
```

CR2
```{r}
# install.packages("devtools")
#devtools::install_github("HEAL-KGS/STICr")
#library(STICr)

tidy_CR2 <- tidy_hobo_data(infile = "TLM_CR2_21359645.csv", outfile = FALSE)
head(tidy_CR2)
#trimming off ends where STICs were in transit...
tidy_CR2 <- tidy_CR2[1:13134,]

```
Below are time series plots of the uncalibrated conductivity and temperature generated by `tidy_hobo_data`

```{r }
plot(tidy_CR2$datetime, tidy_CR2$condUncal, type = "l", lty = 1, 
     xlab = "datetime", ylab = "uncalibrated conductivity")
plot(tidy_CR2$datetime, tidy_CR2$tempC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "temperature")
```

```{r }
# applying the lm_calibration object from the previous example to the tidy data frame to generate the calibrated spc column
CR2_calibrated_df <- apply_calibration(tidy_CR2, lm_calibration)
head(CR2_calibrated_df)
```

Below is a time series plot of the calibrated spc values

```{r }
plot(CR2_calibrated_df$datetime, CR2_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
```

The final function is called `classify_wetdry` and is demonstrated below. This function intakes a data frame with STIC data (such as that produced by `apply_calibration` or `tidy_hobo_data.` The user is also asked to specify a method for classification, as well as a threshold associated with that method. Currently, methods include either an absolute numerical threshold or a percentage of the highest value of the classification variable. It outputs the same STIC data frame as input, except with a new binary column called `wetdry`.

```{r }
# Creating classified data frame using "condUncal" as the classification variable, and an absolute threshold as the method for classification. The SpC threshold chosen in this case is 200. 
CR2_classified_df <- classify_wetdry(CR2_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 200)
head(CR2_classified_df)
```

Below is a time series plot of the calibrated `spc` values colored by wet versus dry periods.

```{r }
CR2_classified_df$wetdry <- as.factor(CR2_classified_df$wetdry)
plot(CR2_classified_df$datetime, CR2_classified_df$condUncal,
     col = 'red',
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(CR2_classified_df$datetime, CR2_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)
```





CP2
```{r}
# install.packages("devtools")
#devtools::install_github("HEAL-KGS/STICr")
#library(STICr)

tidy_CP2 <- tidy_hobo_data(infile = "TLM_CP2_21193670.csv", outfile = FALSE)
head(tidy_CP2)
#trimming off ends where STICs were in transit...
tidy_CP2 <- tidy_CP2[1:13134,]

```

Below are time series plots of the uncalibrated conductivity and temperature generated by `tidy_hobo_data`

```{r }
plot(tidy_CP2$datetime, tidy_CP2$condUncal, type = "l", lty = 1, 
     xlab = "datetime", ylab = "uncalibrated conductivity")
plot(tidy_CP2$datetime, tidy_CP2$tempC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "temperature")
```

```{r }
# applying the lm_calibration object from the previous example to the tidy data frame to generate the calibrated spc column
CP2_calibrated_df <- apply_calibration(tidy_CP2, lm_calibration)
head(CP2_calibrated_df)
```

Below is a time series plot of the calibrated spc values

```{r }
plot(CP2_calibrated_df$datetime, CP2_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
```


```{r }
# Creating classified data frame using "condUncal" as the classification variable, and an absolute threshold as the method for classification. The SpC threshold chosen in this case is 200. 
CP2_classified_df <- classify_wetdry(CP2_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 200)
head(CP2_classified_df)
```

Below is a time series plot of the calibrated `spc` values colored by wet versus dry periods.

```{r }
CP2_classified_df$wetdry <- as.factor(CP2_classified_df$wetdry)
plot(CP2_classified_df$datetime, CP2_classified_df$condUncal,
     col = 'red',
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(CP2_classified_df$datetime, CP2_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)
```


----

 
CT1
```{r}
# install.packages("devtools")
#devtools::install_github("HEAL-KGS/STICr")
#library(STICr)

tidy_CT1 <- tidy_hobo_data(infile = "TLM_CT1_21193669.csv", outfile = FALSE)
head(tidy_CT1)
#trimming off ends where STICs were in transit...
tidy_CT1 <- tidy_CT1[1:13133,]

```
Below are time series plots of the uncalibrated conductivity and temperature generated by `tidy_hobo_data`

```{r }
plot(tidy_CT1$datetime, tidy_CT1$condUncal, type = "l", lty = 1, 
     xlab = "datetime", ylab = "uncalibrated conductivity")
plot(tidy_CT1$datetime, tidy_CT1$tempC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "temperature")
```

```{r }
# applying the lm_calibration object from the previous example to the tidy data frame to generate the calibrated spc column
CT1_calibrated_df <- apply_calibration(tidy_CT1, lm_calibration)
head(CT1_calibrated_df)
```

Below is a time series plot of the calibrated spc values

```{r }
plot(CT1_calibrated_df$datetime, CT1_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
```

The final function is called `classify_wetdry` and is demonstrated below. This function intakes a data frame with STIC data (such as that produced by `apply_calibration` or `tidy_hobo_data.` The user is also asked to specify a method for classification, as well as a threshold associated with that method. Currently, methods include either an absolute numerical threshold or a percentage of the highest value of the classification variable. It outputs the same STIC data frame as input, except with a new binary column called `wetdry`.

```{r }
# Creating classified data frame using "condUncal" as the classification variable, and an absolute threshold as the method for classification. The SpC threshold chosen in this case is 200. 
CT1_classified_df <- classify_wetdry(CT1_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 1000)
head(CT1_classified_df)
```

Below is a time series plot of the calibrated `spc` values colored by wet versus dry periods.

```{r }
CT1_classified_df$wetdry <- as.factor(CT1_classified_df$wetdry)
plot(CT1_classified_df$datetime, CT1_classified_df$condUncal,
     col = CT1_classified_df$wetdry,
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(CT1_classified_df$datetime, CT1_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)
```

-----

CR1
```{r}
# install.packages("devtools")
#devtools::install_github("HEAL-KGS/STICr")
#library(STICr)

tidy_CR1 <- tidy_hobo_data(infile = "TLM_CR1_21193637.csv", outfile = FALSE)
head(tidy_CR1)
#trimming off ends where STICs were in transit...
tidy_CR1 <- tidy_CR1[1:13133,]

```
Below are time series plots of the uncalibrated conductivity and temperature generated by `tidy_hobo_data`

```{r }
plot(tidy_CR1$datetime, tidy_CR1$condUncal, type = "l", lty = 1, 
     xlab = "datetime", ylab = "uncalibrated conductivity")
plot(tidy_CR1$datetime, tidy_CR1$tempC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "temperature")
```

```{r }
# applying the lm_calibration object from the previous example to the tidy data frame to generate the calibrated spc column
CR1_calibrated_df <- apply_calibration(tidy_CR1, lm_calibration)
head(CR1_calibrated_df)
```

Below is a time series plot of the calibrated spc values

```{r }
plot(CR1_calibrated_df$datetime, CR1_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
```

The final function is called `classify_wetdry` and is demonstrated below. This function intakes a data frame with STIC data (such as that produced by `apply_calibration` or `tidy_hobo_data.` The user is also asked to specify a method for classification, as well as a threshold associated with that method. Currently, methods include either an absolute numerical threshold or a percentage of the highest value of the classification variable. It outputs the same STIC data frame as input, except with a new binary column called `wetdry`.

```{r }
# Creating classified data frame using "condUncal" as the classification variable, and an absolute threshold as the method for classification. The SpC threshold chosen in this case is 200. 
CR1_classified_df <- classify_wetdry(CR1_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 200)
head(CR1_classified_df)
```

Below is a time series plot of the calibrated `spc` values colored by wet versus dry periods.

```{r }
CR1_classified_df$wetdry <- as.factor(CR1_classified_df$wetdry)
plot(CR1_classified_df$datetime, CR1_classified_df$condUncal,
     col = CR1_classified_df$wetdry,
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(CR1_classified_df$datetime, CR1_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)
```


CP1
```{r}
# install.packages("devtools")
#devtools::install_github("HEAL-KGS/STICr")
#library(STICr)

tidy_CP1 <- tidy_hobo_data(infile = "TLM_CP1_21193627.csv", outfile = FALSE)
head(tidy_CP1)
#trimming off ends where STICs were in transit...
tidy_CP1 <- tidy_CP1[1:13133,]

```
Below are time series plots of the uncalibrated conductivity and temperature generated by `tidy_hobo_data`

```{r }
plot(tidy_CP1$datetime, tidy_CP1$condUncal, type = "l", lty = 1, 
     xlab = "datetime", ylab = "uncalibrated conductivity")
plot(tidy_CP1$datetime, tidy_CP1$tempC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "temperature")
```

```{r }
# applying the lm_calibration object from the previous example to the tidy data frame to generate the calibrated spc column
CP1_calibrated_df <- apply_calibration(tidy_CP1, lm_calibration)
head(CP1_calibrated_df)
```

Below is a time series plot of the calibrated spc values

```{r }
plot(CP1_calibrated_df$datetime, CP1_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
```

The final function is called `classify_wetdry` and is demonstrated below. This function intakes a data frame with STIC data (such as that produced by `apply_calibration` or `tidy_hobo_data.` The user is also asked to specify a method for classification, as well as a threshold associated with that method. Currently, methods include either an absolute numerical threshold or a percentage of the highest value of the classification variable. It outputs the same STIC data frame as input, except with a new binary column called `wetdry`.

```{r }
# Creating classified data frame using "condUncal" as the classification variable, and an absolute threshold as the method for classification. The SpC threshold chosen in this case is 200. 
CP1_classified_df <- classify_wetdry(CP1_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 200)
head(CP1_classified_df)
```

Below is a time series plot of the calibrated `spc` values colored by wet versus dry periods.

```{r }
CP1_classified_df$wetdry <- as.factor(CP1_classified_df$wetdry)
plot(CP1_classified_df$datetime, CP1_classified_df$condUncal,
     col = 'red',
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(CP1_classified_df$datetime, CP1_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)
```







Impact all together
```{r}
# install.packages("devtools")
#devtools::install_github("HEAL-KGS/STICr")
#library(STICr)

tidy_IP1 <- tidy_hobo_data(infile = "TLM_IP1_21193650.csv", outfile = FALSE)
head(tidy_IP1)
#trimming off ends where STICs were in transit...
tidy_IP1 <- tidy_IP1[1:13130,]

tidy_IR1 <- tidy_hobo_data(infile = "TLM_IR1_21359647.csv", outfile = FALSE)
head(tidy_IR1)
#trimming off ends where STICs were in transit...
tidy_IR1 <- tidy_IR1[1:13130,]

tidy_IT1 <- tidy_hobo_data(infile = "TLM_IT1_21359648.csv", outfile = FALSE)
head(tidy_IT1)
#trimming off ends where STICs were in transit...
tidy_IT1 <- tidy_IT1[1:13130,]


tidy_IP2 <- tidy_hobo_data(infile = "TLM_IP2_21193664.csv", outfile = FALSE)
head(tidy_IP2)
#trimming off ends where STICs were in transit...
tidy_IP2 <- tidy_IP2[1:13130,]

tidy_IR2 <- tidy_hobo_data(infile = "TLM_IR2_21193625.csv", outfile = FALSE)
head(tidy_IR2)
#trimming off ends where STICs were in transit...
tidy_IR2 <- tidy_IR2[1:13130,]

tidy_IT2 <- tidy_hobo_data(infile = "TLM_IT2_21184463.csv", outfile = FALSE)
head(tidy_IT2)
#trimming off ends where STICs were in transit...
tidy_IT2 <- tidy_IT2[1:13130,]


```
Below are time series plots of the uncalibrated conductivity and temperature generated by `tidy_hobo_data`

```{r}
plot(tidy_IT1$datetime, tidy_IT1$condUncal, type = "l", lty = 1, 
     xlab = "datetime", ylab = "uncalibrated conductivity")
plot(tidy_CT1$datetime, tidy_CT1$tempC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "temperature")
```

```{r }
# applying the lm_calibration object from the previous example to the tidy data frame to generate the calibrated spc column
IP1_calibrated_df <- apply_calibration(tidy_IP1, lm_calibration)
head(IP1_calibrated_df)

IR1_calibrated_df <- apply_calibration(tidy_IR1, lm_calibration)
head(IR1_calibrated_df)

IT1_calibrated_df <- apply_calibration(tidy_IT1, lm_calibration)
head(IT1_calibrated_df)

IP2_calibrated_df <- apply_calibration(tidy_IP2, lm_calibration)
head(IP2_calibrated_df)

IR2_calibrated_df <- apply_calibration(tidy_IR2, lm_calibration)
head(IR2_calibrated_df)

IT2_calibrated_df <- apply_calibration(tidy_IT2, lm_calibration)
head(IT2_calibrated_df)

```

Below is a time series plot of the calibrated spc values

```{r }
plot(IP1_calibrated_df$datetime, IP1_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
plot(IR1_calibrated_df$datetime, IR1_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
plot(IT1_calibrated_df$datetime, IT1_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
plot(IP2_calibrated_df$datetime, IP2_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
plot(IR2_calibrated_df$datetime, IR2_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
plot(IT2_calibrated_df$datetime, IT2_calibrated_df$SpC, type = "l", lty = 1, 
     xlab = "datetime", ylab = "specific conductivity")
```

The final function is called `classify_wetdry` and is demonstrated below. This function intakes a data frame with STIC data (such as that produced by `apply_calibration` or `tidy_hobo_data.` The user is also asked to specify a method for classification, as well as a threshold associated with that method. Currently, methods include either an absolute numerical threshold or a percentage of the highest value of the classification variable. It outputs the same STIC data frame as input, except with a new binary column called `wetdry`.

```{r }
# Creating classified data frame using "condUncal" as the classification variable, and an absolute threshold as the method for classification. The SpC threshold chosen in this case is 200. 
IP1_classified_df <- classify_wetdry(IP1_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 200)
head(IP1_classified_df)

IR1_classified_df <- classify_wetdry(IR1_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 1000)
head(IR1_classified_df)

IT1_classified_df <- classify_wetdry(IT1_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 1000)
head(IT1_classified_df)

IP2_classified_df <- classify_wetdry(IP2_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 200)
head(IP2_classified_df)

IR2_classified_df <- classify_wetdry(IR2_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 1000)
head(IR2_classified_df)

IT2_classified_df <- classify_wetdry(IT2_calibrated_df, classify_var = "condUncal", method = "absolute",
                                 threshold = 1000)
head(IT2_classified_df)
```

Below is a time series plot of the calibrated `spc` values colored by wet versus dry periods.

```{r }
IP1_classified_df$wetdry <- as.factor(IP1_classified_df$wetdry)
plot(IP1_classified_df$datetime, IP1_classified_df$condUncal,
     col = 'red',
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(IP1_classified_df$datetime, IP1_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)

IR1_classified_df$wetdry <- as.factor(IR1_classified_df$wetdry)
plot(IR1_classified_df$datetime, IR1_classified_df$condUncal,
     col = 'red',
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(IR1_classified_df$datetime, IR1_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)

IT1_classified_df$wetdry <- as.factor(IT1_classified_df$wetdry)
plot(IT1_classified_df$datetime, IT1_classified_df$condUncal,
     col = IT1_classified_df$wetdry,
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(IT1_classified_df$datetime, IT1_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)

IP2_classified_df$wetdry <- as.factor(IP2_classified_df$wetdry)
plot(IP2_classified_df$datetime, IP2_classified_df$condUncal,
     col = 'red',
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(IP2_classified_df$datetime, IP2_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)

IR2_classified_df$wetdry <- as.factor(IR2_classified_df$wetdry)
plot(IR2_classified_df$datetime, IR2_classified_df$condUncal,
     col = 'red',
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(IR2_classified_df$datetime, IR2_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)

IT2_classified_df$wetdry <- as.factor(IT2_classified_df$wetdry)
plot(IT2_classified_df$datetime, IT2_classified_df$condUncal,
     col = IT2_classified_df$wetdry,
     pch = 16, 
     lty = 2, 
     xlab = "datetime", 
     ylab = "cond uncal", 
    lines(IT2_classified_df$datetime, IT2_classified_df$condUncal,
          pch = 18, col = "black", type = "b", lty = 2, lwd = 2))
legend("topright", c("dry", "wet"), 
       fill = c("black","red"), cex = 0.75)
```

OUTPUT TO CSVs
```{r}

write.csv(IP1_classified_df, "IP1_STIC_tibble.csv")
write.csv(IR1_classified_df, "IR1_STIC_tibble.csv")
write.csv(IT1_classified_df, "IT1_STIC_tibble.csv")
write.csv(IP2_classified_df, "IP2_STIC_tibble.csv")
write.csv(IR2_classified_df, "IR2_STIC_tibble.csv")
write.csv(IT2_classified_df, "IT2_STIC_tibble.csv")
write.csv(CP1_classified_df, "CP1_STIC_tibble.csv")
write.csv(CR1_classified_df, "CR1_STIC_tibble.csv")
write.csv(CT1_classified_df, "CT1_STIC_tibble.csv")
write.csv(CP2_classified_df, "CP2_STIC_tibble.csv")
write.csv(CR2_classified_df, "CR2_STIC_tibble.csv")
write.csv(CT2_classified_df, "CT2_STIC_tibble.csv")


```

```{r}
library(tidyverse)
#write.csv(IP1_classified_df, "IP1_STIC_tibble.csv")
#write.csv(IR1_classified_df, "IR1_STIC_tibble.csv")
#write.csv(IT1_classified_df, "IT1_STIC_tibble.csv")
#write.csv(IP2_classified_df, "IP2_STIC_tibble.csv")
#write.csv(IR2_classified_df, "IR2_STIC_tibble.csv")
#write.csv(IT2_classified_df, "IT2_STIC_tibble.csv")
#write.csv(CP1_classified_df, "CP1_STIC_tibble.csv")
#write.csv(CR1_classified_df, "CR1_STIC_tibble.csv")
#write.csv(CT1_classified_df, "CT1_STIC_tibble.csv")
#write.csv(CP2_classified_df, "CP2_STIC_tibble.csv")
#write.csv(CR2_classified_df, "CR2_STIC_tibble.csv")
#write.csv(CT2_classified_df, "CT2_STIC_tibble.csv")


IP1_tib<- add_column(IP1_classified_df,Site=as.factor("IP1")) %>% add_column(Habitat=as.factor("pool")) %>% add_column(Treatment=as.factor("Impact"))
IR1_tib<- add_column(IR1_classified_df,Site=as.factor("IR1"))%>% add_column(Habitat=as.factor("riffle"))%>% add_column(Treatment=as.factor("Impact"))
IT1_tib<- add_column(IT1_classified_df,Site=as.factor("IT1"))%>% add_column(Habitat=as.factor("riparian"))%>% add_column(Treatment=as.factor("Impact"))
IP2_tib<- add_column(IP2_classified_df,Site=as.factor("IP2"))%>% add_column(Habitat=as.factor("pool"))%>% add_column(Treatment=as.factor("Impact"))
IR2_tib<- add_column(IR2_classified_df,Site=as.factor("IR2"))%>% add_column(Habitat=as.factor("riffle"))%>% add_column(Treatment=as.factor("Impact"))
IT2_tib<- add_column(IT2_classified_df,Site=as.factor("IT2"))%>% add_column(Habitat=as.factor("riparian"))%>% add_column(Treatment=as.factor("Impact"))
CP1_tib<- add_column(CP1_classified_df,Site=as.factor("CP1"))%>% add_column(Habitat=as.factor("pool"))%>% add_column(Treatment=as.factor("Impact"))
CR1_tib<- add_column(CR1_classified_df,Site=as.factor("CR1"))%>% add_column(Habitat=as.factor("riffle"))%>% add_column(Treatment=as.factor("Control"))
CT1_tib<- add_column(CT1_classified_df,Site=as.factor("CT1"))%>% add_column(Habitat=as.factor("riparian"))%>% add_column(Treatment=as.factor("Control"))
CP2_tib<- add_column(CP2_classified_df,Site=as.factor("CP2"))%>% add_column(Habitat=as.factor("pool"))%>% add_column(Treatment=as.factor("Control"))
CR2_tib<- add_column(CR2_classified_df,Site=as.factor("CR2"))%>% add_column(Habitat=as.factor("riffle"))%>% add_column(Treatment=as.factor("Control"))
CT2_tib<- add_column(CT2_classified_df,Site=as.factor("CT2"))%>% add_column(Habitat=as.factor("riparian"))%>% add_column(Treatment=as.factor("Control"))


dd_allstics<- rbind(IP1_tib,IR1_tib,IT1_tib,IP2_tib,IR2_tib,IT2_tib,CP1_tib,CR1_tib,CT1_tib,CP2_tib,CR2_tib,CT2_tib)

write.csv(dd_allstics, "All_STICs_tibble.csv")


```

```{r}

all_stics <- read.csv("All_STICs_tibble.csv")
library(scales)
library(lubridate)

all_stics$datetime <- as.POSIXlt(all_stics$datetime, tz = "UTC", format = "%Y-%m-%d %H:%M:%OS")
all_stics$date <- as.POSIXct(all_stics$datetime)
#all_stics$date <- as.POSIXlt(all_stics$datetime, tz = "UTC", format ="%Y-%m-%d")
           
all_stics$day <- day(all_stics$datetime)
all_stics$TreatmeantXHabitat <- factor(all_stics$Site, levels = c("IP1","IP2","CP1","CP2",
                            "IR1","IR2","CR1","CR2",
                            "IT1","IT2","CT1","CT2"))

```

```{r}

#levels(all_stics$Site) <- c("IP1","IP2","CP1","CP2",
 #                           "IR1","IR2","CR1","CR2",
  #                          "IT1","IT2","CT1","CT2")
#all_stics$Site<-as.factor(all_stics$Site)
all_stics$datetime <- as.POSIXct(all_stics$datetime)

dry_down_temp <- ggplot(all_stics, aes(x=datetime, y=tempC, col=wetdry, shape=Treatment))+
    geom_point(size=0.2)+
    facet_wrap(~TreatmeantXHabitat, nr=3)+
     geom_smooth(method='loess', col='black', aes(group=Habitat, linetype=Habitat))
dry_down_temp

```


```{r}
dry_down_SPC <- ggplot(all_stics, aes(x=datetime, y=SpC, col=wetdry, shape=Treatment))+
    geom_point(size=0.2)+
 # geom_line()+
    facet_wrap(~TreatmeantXHabitat, nr=3)+
     geom_smooth(method='loess', col='black', aes(group=Habitat, linetype=Habitat))
    

dry_down_SPC


dry_down_SPCtrt <- ggplot(all_stics, aes(x=datetime, y=SpC, col=wetdry, shape=Treatment))+
    geom_point(size=0.2)+
    facet_wrap(Habitat~Treatment, nr=2)+
     geom_smooth(method='loess', col='black', se=FALSE, aes(group=Habitat, linetype=Habitat))
    

dry_down_SPCtrt


```


## YSI and other site metadata
SMOOTH-STATE ESTIMATE:
```{}
DO_plot <- ggplot(decomp_ysi, aes(x=day, y=DO_.mg.L.)) +
  #geom_line()+
#  stat_summary(fun=mean,geom="line",lwd=1,aes(colour=iv_spatial))+
geom_text(aes(x=0, label="\nDam Activated", y=3), colour="red", angle=90) +
  geom_text(aes(x=27.35, label="\nRe-Wet", y=3), colour="blue", angle=90) + 
  geom_smooth(method='loess', aes(color=(decomp_ysi$iv_spatial)))+
  #stat_summary(aes(color = decomp_ysi$iv_spatial, group = decomp_ysi$iv_spatial), geom = "ribbon", fun = "mean", size= 0.5, alpha=0.1,
   #            fun.min = function(DO_.mg.L.) mean(DO_.mg.L.) - 1.96 / (length(DO_.mg.L.) - 1) * sd(DO_.mg.L.), 
    #           fun.max = function(DO_.mg.L.) mean(DO_.mg.L.) + 1.96 / (length(DO_.mg.L.) - 1) * sd(DO_.mg.L.), show.legend = #TRUE) +
  
  #stat_summary(geom="errorbar", fun.data=mean_cl_boot, width = 0.1, 
    #           size = 1.2, col = "grey57", position = pd)+
  #geom_point(aes(colour=decomp_ysi$iv_spatial, shape=decomp_ysi$microhab)) +
  geom_point(aes(color=(decomp_ysi$iv_spatial), shape=decomp_ysi$microhab), na.rm=TRUE) +
  geom_point(color="red", shape="star", na.rm=TRUE, data = ~subset(., decomp_ysi$LocationID=="TLMD1"))+
  #scale_color_manual(values=c("blue", "red"))+
  scale_colour_brewer(name="Treatment", palette = "Set2")+
  ylab("DO (mg/L)")+
  xlab("Days since damming")+
  geom_vline(xintercept = 0, linetype="dotted", size = 0.3) +   geom_vline(xintercept = 27.35, linetype="dotted", size = 0.3) 
 # geom_ribbon(aes(ymin = DO_.mg.L.-1, ymax = DO_.mg.L.+1, fill=decomp_ysi$iv_spatial), alpha = 0.1)+
#  scale_fill_brewer(name="Treatment", palette = "Set2")


DO_plot
```


## STIC data for each decomposition assay time periods 
Degree-days are required to calculate temperature-normalized exponential decay constants (k) for the decomposition assays, so we'd like to calculate average temperatures for each STIC, for each incubation period. For each time period, I am averaging temperatures starting at the midnight CST following each deployment (5:00:00 GMT), to the midnight before retrieval, trimming off the days of deployment and retrieval to avoid any effect of sampling on sensor readings. 

formatting stic data for summary stats:
```{r}
dd_allstics$Site<- factor(dd_allstics$Site, levels = c("IP1","IP2","CP1","CP2",
                            "IR1","IR2","CR1","CR2",
                            "IT1","IT2","CT1","CT2"))
dd_allstics$wetdry<- factor(dd_allstics$wetdry,levels=c("dry","wet"))
dd_allstics$wetdry_bin <- factor(dd_allstics$wetdry, levels=c("dry","wet"), labels = c(0, 1))
dd_allstics$wetdry_bin <- as.numeric(dd_allstics$wetdry_bin)-1
```

#### T1 - Before
```{r}

#dd_allstics
t1stics <- dd_allstics[dd_allstics$datetime> as.POSIXct("2022-06-08 04:45:00", tz="UTC") & dd_allstics$datetime< as.POSIXct("2022-06-27 05:00:00", tz="UTC"),]
#t1stics <- date_test[date_test$datetime > as.POSIXct("2022-06-07 23:45:00", tz="UTC") & date_test$datetime < as.POSIXct("2022-06-07 23:45:00", tz="UTC")
t1_temp <- ggplot(t1stics, aes(x=datetime, y=tempC, col=wetdry, shape=Treatment))+
    geom_point(size=0.2)+
    facet_wrap(~Site, nr=3)+
     geom_smooth(method='loess', col='black', aes(group=Habitat, linetype=Habitat))
t1_temp

t1_stic_summmary <- t1stics %>% group_by(Site) %>% summarize(time="t1",mean_temp=mean(tempC), sd_temp=sd(tempC), mean_SpC=mean(SpC), sd_SpC=sd(SpC), prc_wet=mean(wetdry_bin))
t1_stic_summmary

```

#### t2a - Before
```{r}
#dd_allstics
t2astics <- dd_allstics[dd_allstics$datetime> as.POSIXct("2022-06-23 04:45:00", tz="UTC") & dd_allstics$datetime< as.POSIXct("2022-07-12 05:00:00", tz="UTC"),]
#t2astics <- date_test[date_test$datetime > as.POSIXct("2022-06-07 23:45:00", tz="UTC") & date_test$datetime < as.POSIXct("2022-06-07 23:45:00", tz="UTC")
t2a_temp <- ggplot(t2astics, aes(x=datetime, y=tempC, col=wetdry, shape=Treatment))+
    geom_point(size=0.2)+
    facet_wrap(~Site, nr=3)+
     geom_smooth(method='loess', col='black', aes(group=Habitat, linetype=Habitat))
t2a_temp

t2a_stic_summmary <- t2astics %>% group_by(Site) %>% summarize(time="t2a",mean_temp=mean(tempC), sd_temp=sd(tempC), mean_SpC=mean(SpC), sd_SpC=sd(SpC), prc_wet=mean(wetdry_bin))
t2a_stic_summmary

```

#### t2b - Before
```{r}

#dd_allstics
t2bstics <- dd_allstics[dd_allstics$datetime> as.POSIXct("2022-06-28 04:45:00", tz="UTC") & dd_allstics$datetime< as.POSIXct("2022-07-22 05:00:00", tz="UTC"),]
#t2bstics <- date_test[date_test$datetime > as.POSIXct("2022-06-07 23:45:00", tz="UTC") & date_test$datetime < as.POSIXct("2022-06-07 23:45:00", tz="UTC")
t2b_temp <- ggplot(t2bstics, aes(x=datetime, y=tempC, col=wetdry, shape=Treatment))+
    geom_point(size=0.2)+
    facet_wrap(~Site, nr=3)+
     geom_smooth(method='loess', col='black', aes(group=Habitat, linetype=Habitat))
t2b_temp

t2b_stic_summmary <- t2bstics %>% group_by(Site) %>% summarize(time="t2b",mean_temp=mean(tempC), sd_temp=sd(tempC), mean_SpC=mean(SpC), sd_SpC=sd(SpC), prc_wet=mean(wetdry_bin))
t2b_stic_summmary

```

#### t3 - flow restoration phase
```{r}

#dd_allstics
t3stics <- dd_allstics[dd_allstics$datetime> as.POSIXct("2022-07-23 04:45:00", tz="UTC") & dd_allstics$datetime< as.POSIXct("2022-08-12 05:00:00", tz="UTC"),]
#t3stics <- date_test[date_test$datetime > as.POSIXct("2022-06-07 23:45:00", tz="UTC") & date_test$datetime < as.POSIXct("2022-06-07 23:45:00", tz="UTC")
t3_temp <- ggplot(t3stics, aes(x=datetime, y=tempC, col=wetdry, shape=Treatment))+
    geom_point(size=0.2)+
    facet_wrap(~Site, nr=3)+
     geom_smooth(method='loess', col='black', aes(group=Habitat, linetype=Habitat))
t3_temp

t3_stic_summmary <- t3stics %>% group_by(Site) %>% summarize(time="t3",mean_temp=mean(tempC), sd_temp=sd(tempC), mean_SpC=mean(SpC), sd_SpC=sd(SpC), prc_wet=mean(wetdry_bin))
t3_stic_summmary

```

```{r}
stic_decomptime_summaries<- rbind(t1_stic_summmary,t2a_stic_summmary,t2b_stic_summmary,t3_stic_summmary)
write.csv(stic_decomptime_summaries, "decomp_STICstats_summaries.csv")

```

Make STIC sensor data plots with markers for T1-T3 and dam activation/release, in-stream only (excluding riparian)
```{r}
### 
all_t_stics <- dd_allstics[dd_allstics$datetime> as.POSIXct("2022-06-06 04:45:00", tz="UTC") & dd_allstics$datetime< as.POSIXct("2022-08-13 05:00:00", tz="UTC"),]

all_t_stics <- all_t_stics[all_t_stics$Habitat!='riparian',]

dam_day<- as.POSIXct("2022-06-27 18:00:00", tz="UTC")
undam_day<- as.POSIXct("2022-07-25 19:00:00", tz="UTC")
tcol<- c("cornflowerblue","brown1")

#library(tidyquant)
all_t_temp <- ggplot(all_t_stics, aes(x=datetime, y=tempC, col=wetdry))+
    geom_point(size=0.2)+
  scale_shape_manual(values=1)+
    facet_wrap(Habitat~Treatment, nr=2)+
  #geom_ma(ma_fun = SMA, n = 192, color="black", linewidth=0.1, linetype='dashed') + 
     geom_smooth(method='gam', col='black' #, aes(group=Habitat, linetype=Habitat)
                 )+
  scale_color_manual(values = tcol)
all_t_temp

t1min<- as.POSIXct("2022-06-07 18:00:00", tz="UTC")
t1mid<- as.POSIXct("2022-06-27 18:00:00", tz="UTC") - days(10) 
t1max<- as.POSIXct("2022-06-27 18:00:00", tz="UTC")

t2amin<- as.POSIXct("2022-06-22 18:00:00", tz="UTC")
t2amid<- as.POSIXct("2022-07-12 18:00:00", tz="UTC") - days(10) 
t2amax<- as.POSIXct("2022-07-12 18:00:00", tz="UTC")

t2bmin<- as.POSIXct("2022-06-27 18:00:00", tz="UTC")
t2bmid<- as.POSIXct("2022-07-22 6:00:00", tz="UTC") - days(12) 
t2bmax<- as.POSIXct("2022-07-22 18:00:00", tz="UTC")

t3min<- as.POSIXct("2022-07-22 18:00:00", tz="UTC")
t3mid<- as.POSIXct("2022-08-12 6:00:00", tz="UTC") - days(10)
t3max<- as.POSIXct("2022-08-12 18:00:00", tz="UTC")

all_t_temp_annotated <- all_t_temp+
  aes(ymin=0, ymax=30)+
      geom_vline(xintercept = dam_day, linetype="dotted", size = 0.3) +   geom_vline(xintercept = undam_day, linetype="dotted", size = 0.3) +
  annotate('text', x=dam_day, y=12, label = "\nFlow diversion",  angle=90, size=2.5)+
  annotate('text', x=undam_day, y=12, label = "\nFlow restoration",  angle=90, size=2.5)+
  ### rectangles to represent incubation phases
  ## t1
    annotate('rect', xmin = t1min, xmax = t1max, ymin = 0, ymax = 2, alpha = 0.7, fill = 'blue', col = 'black')+
  annotate('text', x=t1mid , y=1, label = "t1", size=2.5)+
  ## t2a
    annotate('rect', xmin = t2amin, xmax = t2amax, ymin = 2, ymax = 4, alpha = 0.7, fill = 'yellow', col = 'black')+
  annotate('text', x=t2amid , y=3, label = "t2a",   size=2.5)+
  ## t2b
    annotate('rect', xmin = t2bmin, xmax = t2bmax, ymin = 0, ymax = 2, alpha = 0.7, fill = 'red', col = 'black')+
  annotate('text', x=t2bmid , y=1, label = "t2b",   size=2.5)+
  ## t3
    annotate('rect', xmin = t3min, xmax = t3max, ymin = 0, ymax = 2, alpha = 0.7, fill = 'green', col = 'black')+
  annotate('text', x=t3mid , y=1, label = "t3",   size=2.5)
all_t_temp_annotated

library(ragg)
plotout <- "Stream_temperature.tiff"
agg_tiff(filename=plotout, width=4200, height=2000, units="px",
         pointsize=10, res=600, compression="lzw", scaling=0.5)
all_t_temp_annotated
#plot_grid(nmds2plus,ASVaccumsub,venndiagram,dbRDA_B,dbRDAL,dbRDA_S, labels="AUTO", ncol=3)
invisible(dev.off())

```

```{r}
### 
all_t_stics <- dd_allstics[dd_allstics$datetime> as.POSIXct("2022-06-06 04:45:00", tz="UTC") & dd_allstics$datetime< as.POSIXct("2022-08-13 05:00:00", tz="UTC"),]

all_t_stics <- all_t_stics[all_t_stics$Habitat!='riparian',]

dam_day<- as.POSIXct("2022-06-27 18:00:00", tz="UTC")
undam_day<- as.POSIXct("2022-07-25 19:00:00", tz="UTC")
tcol<- c("cornflowerblue","brown1")

#library(tidyquant)
all_SPC_temp <- ggplot(all_t_stics, aes(x=datetime, y=SpC, col=wetdry))+
    geom_point(size=0.2)+
  scale_shape_manual(values=1)+
    facet_wrap(Habitat~Treatment, nr=2)+
  #geom_ma(ma_fun = SMA, n = 192, color="black", linewidth=0.1, linetype='dashed') + 
     geom_smooth(method='gam', col='black' #, aes(group=Habitat, linetype=Habitat)
                 )+
  scale_color_manual(values = tcol)
all_SPC_temp

t1min<- as.POSIXct("2022-06-07 18:00:00", tz="UTC")
t1mid<- as.POSIXct("2022-06-27 18:00:00", tz="UTC") - days(10) 
t1max<- as.POSIXct("2022-06-27 18:00:00", tz="UTC")

t2amin<- as.POSIXct("2022-06-22 18:00:00", tz="UTC")
t2amid<- as.POSIXct("2022-07-12 18:00:00", tz="UTC") - days(10) 
t2amax<- as.POSIXct("2022-07-12 18:00:00", tz="UTC")

t2bmin<- as.POSIXct("2022-06-27 18:00:00", tz="UTC")
t2bmid<- as.POSIXct("2022-07-22 6:00:00", tz="UTC") - days(12) 
t2bmax<- as.POSIXct("2022-07-22 18:00:00", tz="UTC")

t3min<- as.POSIXct("2022-07-22 18:00:00", tz="UTC")
t3mid<- as.POSIXct("2022-08-12 6:00:00", tz="UTC") - days(10)
t3max<- as.POSIXct("2022-08-12 18:00:00", tz="UTC")

all_t_SPC_annotated <- all_SPC_temp+
  aes(ymin=0, ymax=30)+
      geom_vline(xintercept = dam_day, linetype="dotted", size = 0.3) +   geom_vline(xintercept = undam_day, linetype="dotted", size = 0.3) +
  annotate('text', x=dam_day, y=12, label = "\nFlow diversion",  angle=90, size=2.5)+
  annotate('text', x=undam_day, y=12, label = "\nFlow restoration",  angle=90, size=2.5)+
  ### rectangles to represent incubation phases
  ## t1
    annotate('rect', xmin = t1min, xmax = t1max, ymin = 0, ymax = 2, alpha = 0.7, fill = 'blue', col = 'black')+
  annotate('text', x=t1mid , y=1, label = "t1", size=2.5)+
  ## t2a
    annotate('rect', xmin = t2amin, xmax = t2amax, ymin = 2, ymax = 4, alpha = 0.7, fill = 'yellow', col = 'black')+
  annotate('text', x=t2amid , y=3, label = "t2a",   size=2.5)+
  ## t2b
    annotate('rect', xmin = t2bmin, xmax = t2bmax, ymin = 0, ymax = 2, alpha = 0.7, fill = 'red', col = 'black')+
  annotate('text', x=t2bmid , y=1, label = "t2b",   size=2.5)+
  ## t3
    annotate('rect', xmin = t3min, xmax = t3max, ymin = 0, ymax = 2, alpha = 0.7, fill = 'green', col = 'black')+
  annotate('text', x=t3mid , y=1, label = "t3",   size=2.5)
all_t_SPC_annotated

library(ragg)
plotout <- "Stream_SpC.tiff"
agg_tiff(filename=plotout, width=4200, height=2000, units="px",
         pointsize=10, res=600, compression="lzw", scaling=0.5)
all_t_SPC_annotated
#plot_grid(nmds2plus,ASVaccumsub,venndiagram,dbRDA_B,dbRDAL,dbRDA_S, labels="AUTO", ncol=3)
invisible(dev.off())

```

